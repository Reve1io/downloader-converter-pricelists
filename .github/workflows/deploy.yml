name: CI/CD Deploy Downloader-converter-pricelists

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

env:
  PROJECT_DIR: /home/romad/downloader-converter-pricelists
  CONTAINER_NAME: downloader-converter-cron

jobs:
  test:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25'
      
      - name: Run tests
        run: |
          go test ./... -v
          go vet ./...

  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.PASSWORD }}  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª—é—á –≤–º–µ—Å—Ç–æ –ø–∞—Ä–æ–ª—è
          port: ${{ secrets.SSH_PORT || 22 }}
          script_timeout: 10m
          script: |
            set -e  # –í—ã—Ö–æ–¥ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –æ—à–∏–±–∫–µ
            echo "üöÄ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è –≤ $(date)"
            
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            cd "${{ env.PROJECT_DIR }}"
            
            echo "üìÇ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
            echo "üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞:"
            df -h .
            
            # 1. –°–û–•–†–ê–ù–ï–ù–ò–ï –ß–£–í–°–¢–í–ò–¢–ï–õ–¨–ù–´–• –î–ê–ù–ù–´–•
            echo "üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ..."
            
            # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±—ç–∫–∞–ø–∞
            BACKUP_DIR="/tmp/deploy_backup_$(date +%Y%m%d_%H%M%S)"
            mkdir -p "$BACKUP_DIR"
            
            # –ö–æ–ø–∏—Ä—É–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –µ—Å–ª–∏ –æ–Ω–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
            declare -a SENSITIVE_FILES=(
              "configs/config.yaml"
              "docker/cron/.env"
              ".env.production"
              "data/.gitkeep"
            )
            
            for file in "${SENSITIVE_FILES[@]}"; do
              if [ -f "$file" ] || [ -d "$file" ]; then
                echo "  üìÅ –°–æ—Ö—Ä–∞–Ω—è—é: $file"
                cp -r "$file" "$BACKUP_DIR/" 2>/dev/null || true
              fi
            done
            
            # 2. –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–û–î–ê
            echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å git
            CURRENT_BRANCH=$(git branch --show-current)
            echo "  –¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞: $CURRENT_BRANCH"
            
            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            git reset --hard HEAD
            git clean -fd -e "configs/" -e "docker/cron/.env" -e ".env.production" -e "data/"
            
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            git fetch origin --depth=1
            git checkout -f master
            git reset --hard origin/master
            git pull origin master --ff-only
            
            echo "  ‚úÖ –ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω. –ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç:"
            git log -1 --oneline
            
            # 3. –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–•
            echo "üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ..."
            
            if [ -d "$BACKUP_DIR" ]; then
              # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∞–π–ª—ã –∏–∑ –±—ç–∫–∞–ø–∞
              for file in "${SENSITIVE_FILES[@]}"; do
                backup_file="$BACKUP_DIR/$(basename "$file")"
                if [ -f "$backup_file" ] || [ -d "$backup_file" ]; then
                  echo "  üìÅ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é: $file"
                  mkdir -p "$(dirname "$file")"
                  cp -r "$backup_file" "$file" 2>/dev/null || true
                fi
              done
              
              # –û—á–∏—â–∞–µ–º –±—ç–∫–∞–ø
              rm -rf "$BACKUP_DIR"
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã
            if [ ! -f "configs/config.yaml" ]; then
              echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: configs/config.yaml –Ω–µ –Ω–∞–π–¥–µ–Ω"
              echo "   –°–æ–∑–¥–∞—é –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥..."
              mkdir -p configs
              cat > configs/config.yaml << EOF
            # Auto-generated config
              log_dir: /app/logs
              data_dir: /app/data
            EOF
            fi
            
            # 4. –°–ë–û–†–ö–ê –ò –ó–ê–ü–£–°–ö
            echo "üê≥ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            docker-compose down --remove-orphans --timeout 30 || true
            
            echo "üßπ –û—á–∏—â–∞–µ–º Docker..."
            docker system prune -f --filter "until=24h"
            docker image prune -f
            docker volume prune -f
            
            echo "üî® –°–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑..."
            docker-compose build --no-cache --pull
            
            echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            docker-compose up -d --remove-orphans
            
            # 5. –ü–†–û–í–ï–†–ö–ê –ò –ú–û–ù–ò–¢–û–†–ò–ù–ì
            echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (10 —Å–µ–∫—É–Ω–¥)..."
            sleep 10
            
            echo "üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è:"
            echo "=========================================="
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            echo "üü¢ –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
            docker-compose ps
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            echo "ü©∫ Health check:"
            if docker-compose exec -T ${{ env.CONTAINER_NAME }} /app/healthcheck.sh; then
              echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–¥–æ—Ä–æ–≤"
            else
              echo "‚ùå –ü—Ä–æ–±–ª–µ–º—ã —Å health check"
              exit 1
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ Cron
            echo "üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ Cron:"
            docker-compose exec -T ${{ env.CONTAINER_NAME }} crontab -l || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ"
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏
            echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ (20 —Å—Ç—Ä–æ–∫):"
            docker-compose logs --tail=20 ${{ env.CONTAINER_NAME }} 2>/dev/null || echo "–õ–æ–≥–∏ –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
            echo "üíæ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤:"
            docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}" | head -5
            
            echo ""
            echo "üéâ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω –≤ $(date)"
            echo ""
            echo "üîß –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞:"
            echo "   –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤:    docker-compose logs -f ${{ env.CONTAINER_NAME }}"
            echo "   –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫:     docker-compose exec ${{ env.CONTAINER_NAME }} /app/run-with-retry.sh"
            echo "   –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è: docker-compose exec ${{ env.CONTAINER_NAME }} /app/healthcheck.sh"
            echo "   –û–±–Ω–æ–≤–∏—Ç—å –æ–±—Ä–∞–∑:    cd ${{ env.PROJECT_DIR }} && git pull && docker-compose up -d --build"
            echo "   –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å:        docker-compose down"
            
            # 6. –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –û–ë –£–°–ü–ï–•–ï
            echo "üìß –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è..."
            DEPLOY_TIME=$(date)
            COMMIT_HASH=$(git log -1 --pretty=format:"%h")
            COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s")
            AUTHOR=$(git log -1 --pretty=format:"%an")
            
            # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –≤ Slack/Telegram
            echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–µ–Ω!"
            echo "   –í—Ä–µ–º—è: $DEPLOY_TIME"
            echo "   –ö–æ–º–º–∏—Ç: $COMMIT_HASH - $COMMIT_MESSAGE"
            echo "   –ê–≤—Ç–æ—Ä: $AUTHOR"